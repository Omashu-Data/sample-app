<!-- Tab de Estadísticas -->
<div class="stats-container">
  <div class="stats-header glass-panel">
    <div class="stats-title">
      <h2>Estadísticas de <span id="stats-player-name">Invocador</span></h2>
      <div class="stats-subtitle">
        <span id="stats-match-type">Partida Normal</span> - <span id="stats-game-time">00:00</span>
        </div>
      </div>
    </div>
    
  <div class="stats-sections">
    <!-- Sección de KDA Detallado -->
    <div class="stats-section glass-panel">
      <div class="stats-section-header">
        <h3>Desempeño en Combate</h3>
      </div>
      <div class="stats-section-content">
        <div class="stats-kda-container">
          <div class="stats-kda-card">
            <div class="stats-kda-value" id="stats-kills">0</div>
            <div class="stats-kda-label">Eliminaciones</div>
        </div>
          <div class="stats-kda-card">
            <div class="stats-kda-value" id="stats-deaths">0</div>
            <div class="stats-kda-label">Muertes</div>
      </div>
          <div class="stats-kda-card">
            <div class="stats-kda-value" id="stats-assists">0</div>
            <div class="stats-kda-label">Asistencias</div>
        </div>
          <div class="stats-kda-card">
            <div class="stats-kda-value" id="stats-kda-ratio">0.0</div>
            <div class="stats-kda-label">Ratio KDA</div>
      </div>
        </div>
      </div>
    </div>
    
    <!-- Sección de Recursos -->
    <div class="stats-section glass-panel">
      <div class="stats-section-header">
        <h3>Recursos y Economía</h3>
      </div>
      <div class="stats-section-content">
        <div class="stats-metrics-grid">
          <div class="stats-metric">
            <div class="stats-metric-icon">
              <img src="../../img/gold-icon.svg" alt="Oro" />
      </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Oro Total</div>
              <div class="stats-metric-value" id="stats-gold">0</div>
      </div>
    </div>
    
          <div class="stats-metric">
            <div class="stats-metric-icon">
              <img src="../../img/cs-icon.svg" alt="CS" />
      </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">CS Total</div>
              <div class="stats-metric-value" id="stats-cs">0</div>
      </div>
    </div>
    
          <div class="stats-metric">
            <div class="stats-metric-icon">
              <img src="../../img/cs-per-min-icon.svg" alt="CS por minuto" />
      </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">CS por Minuto</div>
              <div class="stats-metric-value" id="stats-cs-per-min">0.0</div>
      </div>
    </div>
    
          <div class="stats-metric">
            <div class="stats-metric-icon">
              <img src="../../img/ward-icon.svg" alt="Wards" />
      </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Wards Colocados</div>
              <div class="stats-metric-value" id="stats-wards-placed">0</div>
      </div>
    </div>
        </div>
      </div>
    </div>
    
    <!-- Sección de Daño -->
    <div class="stats-section glass-panel">
      <div class="stats-section-header">
        <h3>Análisis de Daño</h3>
      </div>
      <div class="stats-section-content">
        <div class="stats-metrics-grid">
          <div class="stats-metric">
            <div class="stats-metric-icon damage-icon">
              <img src="../../img/damage-icon.svg" alt="Daño" />
      </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Daño Total</div>
              <div class="stats-metric-value" id="stats-total-damage">0</div>
      </div>
    </div>
    
          <div class="stats-metric">
            <div class="stats-metric-icon damage-icon">
              <img src="../../img/champion-damage-icon.svg" alt="Daño a campeones" />
      </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Daño a Campeones</div>
              <div class="stats-metric-value" id="stats-champion-damage">0</div>
      </div>
    </div>
    
          <div class="stats-metric">
            <div class="stats-metric-icon heal-icon">
              <img src="../../img/healing-icon.svg" alt="Curación" />
      </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Curación Total</div>
              <div class="stats-metric-value" id="stats-total-healing">0</div>
      </div>
    </div>
    
          <div class="stats-metric">
            <div class="stats-metric-icon damage-icon">
              <img src="../../img/damage-taken-icon.svg" alt="Daño recibido" />
      </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Daño Recibido</div>
              <div class="stats-metric-value" id="stats-damage-taken">0</div>
        </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- NUEVA SECCIÓN: TABLA DE VARIABLES -->
    <div class="stats-section glass-panel">
      <div class="stats-section-header">
        <h3>Variables Disponibles</h3>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button id="btn-filtrar-vars" style="background: #444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
            Filtrar Vacíos
          </button>
          <button id="btn-exportar-vars" style="background: #00AA00; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
            Exportar JSON
          </button>
        </div>
          </div>
      <div class="stats-section-content">
        <div class="variables-filtro">
          <input type="text" id="filtro-variables" placeholder="Filtrar variables..." style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #444; background: rgba(0,0,0,0.2); color: white;">
        </div>
        <div class="variables-wrapper" style="max-height: 400px; overflow-y: auto;">
          <table id="tabla-variables" style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr style="background-color: rgba(0,0,0,0.3); position: sticky; top: 0;">
                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #444;">Variable</th>
                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #444;">Valor</th>
              </tr>
            </thead>
            <tbody id="variables-body">
              <!-- Aquí se insertarán dinámicamente las variables -->
              <tr>
                <td colspan="2" style="text-align: center; padding: 20px;">Cargando variables...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Función para formatear el tiempo de juego - misma que en tab-overview.html
  function formatGameTime(seconds) {
    if (!seconds && seconds !== 0) return "00:00";
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  // Función para formatear números grandes con separadores de mil
  function formatNumber(num) {
    return new Intl.NumberFormat('es-ES').format(num);
  }

  // Función para calcular el ratio KDA
  function calculateKDARatio(kills, deaths, assists) {
    if (deaths === 0) return ((kills + assists) > 0 ? "Perfect" : "0.0");
    return ((kills + assists) / deaths).toFixed(1);
  }
  
  // Variables para seguimiento de datos
  let ultimosDatos = {};
  let variablesFiltradas = false;
  
  // Función para actualizar la tabla de variables - NO INTERFIERE con updateUI
  function actualizarTablaVariables(gameData) {
    console.log("[TABLA] Iniciando actualizarTablaVariables con datos:", 
                gameData ? "datos presentes" : "sin datos", 
                "allPlayers:", gameData && gameData.allPlayers ? "presentes" : "no disponibles");
    
    try {
      // Guardar los datos para exportación
      ultimosDatos = JSON.parse(JSON.stringify(gameData || {}));
      
      // Obtener el cuerpo de la tabla
      const tbody = document.getElementById('variables-body');
      if (!tbody) {
        console.error("[TABLA] No se encontró el elemento #variables-body");
        return;
      }
      
      // Obtener el valor del filtro
      const filtroTexto = document.getElementById('filtro-variables')?.value.toLowerCase() || '';
      
      // Limpiar contenido existente
      tbody.innerHTML = '';
      
      // Si no hay datos, mostrar mensaje
      if (!gameData || Object.keys(gameData).length === 0) {
        const fila = document.createElement('tr');
        const celda = document.createElement('td');
        celda.colSpan = 2;
        celda.style.textAlign = 'center';
        celda.style.padding = '20px';
        celda.textContent = 'No hay datos disponibles del juego';
        fila.appendChild(celda);
        tbody.appendChild(fila);
        console.error("[TABLA] No hay datos disponibles para mostrar");
        return;
      }
      
      // Función recursiva para procesar todas las propiedades anidadas
      function procesarObjeto(obj, prefijo = '') {
        if (!obj || typeof obj !== 'object') {
          console.log("[TABLA] Objeto inválido o no es un objeto:", obj);
          return;
        }
        
        // Ordenar las claves alfabéticamente
        const claves = Object.keys(obj).sort();
        console.log("[TABLA] Procesando objeto con claves:", claves.join(", ").substring(0, 100) + "...");
        
        let filas = 0;
        for (const clave of claves) {
          const valor = obj[clave];
          const nombreCompleto = prefijo ? `${prefijo}.${clave}` : clave;
          
          // Filtrar por texto si existe un filtro
          if (filtroTexto && !nombreCompleto.toLowerCase().includes(filtroTexto)) {
            continue;
          }
          
          // Filtrar valores vacíos si está activado
          if (variablesFiltradas && (valor === undefined || valor === null || valor === '' || 
              (typeof valor === 'object' && Object.keys(valor).length === 0))) {
            continue;
          }
          
          // Crear fila para esta propiedad
          const fila = document.createElement('tr');
          fila.style.borderBottom = '1px solid #333';
          
          // Celda para el nombre de la variable
          const celdaNombre = document.createElement('td');
          celdaNombre.style.padding = '6px';
          celdaNombre.style.fontWeight = 'bold';
          celdaNombre.textContent = nombreCompleto;
          
          // Celda para el valor
          const celdaValor = document.createElement('td');
          celdaValor.style.padding = '6px';
          
          // Formatear el valor según su tipo
          if (valor === null) {
            celdaValor.textContent = 'null';
            celdaValor.style.color = '#888';
          } else if (valor === undefined) {
            celdaValor.textContent = 'undefined';
            celdaValor.style.color = '#888';
          } else if (typeof valor === 'object') {
            if (Array.isArray(valor)) {
              celdaValor.textContent = `Array[${valor.length}]`;
              celdaValor.style.color = '#5F9EA0';
              
              // Para arrays, mostrar elementos si no son muchos
              if (valor.length > 0 && valor.length < 10) {
                procesarObjeto(valor, nombreCompleto);
              }
            } else {
              celdaValor.textContent = `Object{${Object.keys(valor).length} props}`;
              celdaValor.style.color = '#7B68EE';
              
              // Si es un objeto, procesar sus propiedades de forma recursiva
              procesarObjeto(valor, nombreCompleto);
            }
          } else {
            // Para valores simples
            if (typeof valor === 'boolean') {
              celdaValor.textContent = valor.toString();
              celdaValor.style.color = valor ? '#4CAF50' : '#F44336';
            } else if (typeof valor === 'number') {
              celdaValor.textContent = valor.toString();
              celdaValor.style.color = '#03A9F4';
            } else {
              celdaValor.textContent = valor.toString();
            }
          }
          
          // Añadir celdas a la fila
          fila.appendChild(celdaNombre);
          fila.appendChild(celdaValor);
          
          // Añadir fila a la tabla
          tbody.appendChild(fila);
          filas++;
          
          // Limitar el número de filas para evitar sobrecarga
          if (filas > 500) {
            console.warn("[TABLA] Limitando visualización a 500 filas para evitar sobrecarga");
            break;
          }
        }
        
        return filas;
      }
      
      // Iniciar procesamiento
      const totalFilas = procesarObjeto(gameData);
      console.log(`[TABLA] Total de filas procesadas: ${totalFilas || 0}`);
      
      // Mostrar mensaje si no hay variables
      if (tbody.childElementCount === 0) {
        const fila = document.createElement('tr');
        const celda = document.createElement('td');
        celda.colSpan = 2;
        celda.style.textAlign = 'center';
        celda.style.padding = '20px';
        celda.textContent = 'No se encontraron variables con los filtros actuales';
        fila.appendChild(celda);
        tbody.appendChild(fila);
        console.warn("[TABLA] No se encontraron variables que coincidan con los filtros");
      }
    } catch (error) {
      console.error("[TABLA] Error al procesar la tabla de variables:", error);
      
      // Crear mensaje de error en la tabla
      const tbody = document.getElementById('variables-body');
      if (tbody) {
        tbody.innerHTML = '';
        const fila = document.createElement('tr');
        const celda = document.createElement('td');
        celda.colSpan = 2;
        celda.style.textAlign = 'center';
        celda.style.padding = '20px';
        celda.style.color = '#FF5555';
        celda.textContent = `Error al procesar variables: ${error.message}`;
        fila.appendChild(celda);
        tbody.appendChild(fila);
      }
    }
  }

  // ========== FUNCIÓN PRINCIPAL DE ACTUALIZACIÓN DE UI ==========
  // Esta función sigue EXACTAMENTE el mismo patrón que tab-overview.html
  function updateUI(gameData) {
    console.log("[tab-stats] Actualizando con datos:", {
      summoner: gameData.summoner ? gameData.summoner.name : "no disponible",
      gameTime: gameData.match ? gameData.match.gameTime : "no disponible",
      kda: gameData.match ? `${gameData.match.kills}/${gameData.match.deaths}/${gameData.match.assists}` : "no disponible"
    });
    
    // Datos crudos para depuración
    console.log("[tab-stats] Estructura de datos completa:", JSON.stringify(gameData).substring(0, 500) + "...");
    
    // IMPORTANTE: Actualizar primero las variables principales
    
    // Información del jugador
    if (gameData.summoner) {
      document.getElementById('stats-player-name').textContent = gameData.summoner.name || "Invocador";
    }
    
    // Tipo de partida y tiempo
    if (gameData.match) {
      if (gameData.match.gameMode) {
        document.getElementById('stats-match-type').textContent = gameData.match.gameMode;
      }
      
      if (gameData.match.gameTime !== undefined) {
        document.getElementById('stats-game-time').textContent = formatGameTime(gameData.match.gameTime);
      }
      
      // KDA - MISMO PATRÓN QUE TAB-OVERVIEW
      document.getElementById('stats-kills').textContent = gameData.match.kills || 0;
      document.getElementById('stats-deaths').textContent = gameData.match.deaths || 0;
      document.getElementById('stats-assists').textContent = gameData.match.assists || 0;
      
      // Ratio KDA
      const kills = parseInt(gameData.match.kills) || 0;
      const deaths = parseInt(gameData.match.deaths) || 0;
      const assists = parseInt(gameData.match.assists) || 0;
      document.getElementById('stats-kda-ratio').textContent = calculateKDARatio(kills, deaths, assists);
      
      // CS y CS por minuto
      if (gameData.match.cs !== undefined) {
        document.getElementById('stats-cs').textContent = gameData.match.cs;
        
        if (gameData.match.gameTime !== undefined && gameData.match.gameTime > 0) {
          const gameTimeInMinutes = Math.max(gameData.match.gameTime / 60, 1);
          const csPerMinute = (gameData.match.cs / gameTimeInMinutes).toFixed(1);
          document.getElementById('stats-cs-per-min').textContent = csPerMinute;
        }
      }
      
      // Oro - Verificar múltiples ubicaciones posibles
      if (gameData.match.gold !== undefined) {
        document.getElementById('stats-gold').textContent = formatNumber(gameData.match.gold);
      } else if (gameData.gold !== undefined) {
        console.log("Encontrado oro en gameData.gold en lugar de gameData.match.gold");
        document.getElementById('stats-gold').textContent = formatNumber(gameData.gold);
      }
    }
    
    // Wards desde múltiples fuentes posibles
    let wardsPlaced = 0;
    if (gameData.ward && gameData.ward.placed !== undefined) {
      wardsPlaced = parseInt(gameData.ward.placed) || 0;
    } else if (gameData.vision && gameData.vision.wardsPlaced !== undefined) {
      wardsPlaced = gameData.vision.wardsPlaced;
    } else if (gameData.objectives && gameData.objectives.wardPlaced !== undefined) {
      wardsPlaced = gameData.objectives.wardPlaced;
    }
    document.getElementById('stats-wards-placed').textContent = wardsPlaced;
    
    // Daño desde diferentes fuentes
    if (gameData.combat) {
      if (gameData.combat.damageDealt !== undefined) {
        document.getElementById('stats-total-damage').textContent = formatNumber(gameData.combat.damageDealt);
      }
      
      if (gameData.combat.totalDamageToChampions !== undefined) {
        document.getElementById('stats-champion-damage').textContent = formatNumber(gameData.combat.totalDamageToChampions);
      } else if (gameData.combat.damageDealtToChampions !== undefined) {
        document.getElementById('stats-champion-damage').textContent = formatNumber(gameData.combat.damageDealtToChampions);
      }
      
      if (gameData.combat.damageTaken !== undefined) {
        document.getElementById('stats-damage-taken').textContent = formatNumber(gameData.combat.damageTaken);
      }
      
      if (gameData.combat.healing !== undefined) {
        document.getElementById('stats-total-healing').textContent = formatNumber(gameData.combat.healing);
      } else if (gameData.combat.healingDone !== undefined) {
        document.getElementById('stats-total-healing').textContent = formatNumber(gameData.combat.healingDone);
      }
    }
    
    // IMPORTANTE: Actualizar tabla de variables DESPUÉS de updateUI principal
    // para que no interfiera con la actualización principal
    setTimeout(function() {
      try {
        console.log("[tab-stats] Llamando a actualizarTablaVariables con datos del juego");
        actualizarTablaVariables(gameData);
      } catch (e) {
        console.error("Error al actualizar tabla de variables:", e);
        // Esto no debe detener la actualización principal
      }
    }, 10);
  }
  
  // Función para exportar datos a JSON
  function exportarVariablesJSON() {
    if (!ultimosDatos || Object.keys(ultimosDatos).length === 0) {
      alert("No hay datos disponibles para exportar");
      return;
    }
    
    try {
      const jsonStr = JSON.stringify(ultimosDatos, null, 2);
      
      // Usar la API de Overwolf para guardar el archivo
      const fileName = `lol-variables-${new Date().toISOString().replace(/:/g, '-')}.json`;
      const overwolfFileName = `${overwolf.io.paths.documents}\\Overwolf\\${fileName}`;
      
      // Método específico de Overwolf para escribir archivos
      overwolf.io.writeFileContents(
        overwolfFileName, 
        jsonStr, 
        "UTF8", 
        true, 
        (result) => {
          if (result.success) {
            // Mostrar notificación de éxito
            overwolf.notifications.showToast({
              header: "Variables exportadas",
              message: `Guardado en: ${overwolfFileName}`,
              duration: 5
            });
            
            console.log(`Variables guardadas con éxito en: ${overwolfFileName}`);
          } else {
            console.error("Error al exportar variables:", result.error);
            alert(`Error al exportar variables: ${result.error}`);
          }
        }
      );
    } catch (e) {
      console.error("Error exportando datos:", e);
      alert("Error al exportar datos: " + e.message);
    }
  }

  // Inicialización - SIGUE EXACTAMENTE EL MISMO PATRÓN QUE TAB-OVERVIEW.HTML
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Tab-stats cargado, iniciando exactamente como tab-overview...");
    
    try {
      // Adjuntar eventos a los botones y filtro
      const btnFiltrar = document.getElementById('btn-filtrar-vars');
      if (btnFiltrar) {
        btnFiltrar.addEventListener('click', function() {
          variablesFiltradas = !variablesFiltradas;
          this.textContent = variablesFiltradas ? 'Mostrar Todos' : 'Filtrar Vacíos';
          actualizarTablaVariables(ultimosDatos);
        });
      }
      
      const btnExportar = document.getElementById('btn-exportar-vars');
      if (btnExportar) {
        btnExportar.addEventListener('click', exportarVariablesJSON);
      }
      
      const filtroInput = document.getElementById('filtro-variables');
      if (filtroInput) {
        filtroInput.addEventListener('input', function() {
          actualizarTablaVariables(ultimosDatos);
        });
      }
      
      // CAMBIO IMPORTANTE: Adjuntar la función updateUI al elemento de pestaña
      // EXACTAMENTE como en tab-overview.html
      const tabElement = document.querySelector('.stats-container').closest('.tabs__pane') || 
                        document.getElementById('stats-tab');
      
      if (tabElement) {
        console.log("Adjuntando función updateUI al elemento de pestaña:", tabElement.id);
        
        // Guardar la función en el elemento - EXACTAMENTE como en tab-overview.html
        tabElement.updateUIFunction = updateUI;
        
        // Registro global como respaldo - EXACTAMENTE como en tab-overview.html
        if (!window.tabUpdateFunctions) window.tabUpdateFunctions = {};
        window.tabUpdateFunctions['stats-tab'] = updateUI;
        
        // Exponer la función actualizarTablaVariables para acceso directo
        tabElement.actualizarTablaVariables = actualizarTablaVariables;
      } else {
        console.warn("No se pudo encontrar el elemento de pestaña para adjuntar updateUI");
      }
      
      // SUBSCRIPCIONES - EXACTAMENTE como en tab-overview.html
      if (typeof window.subscribeToGameData === 'function') {
        console.log("Usando window.subscribeToGameData");
        window.subscribeToGameData(updateUI);
      } 
      else if (window.gameDataManager && typeof window.gameDataManager.subscribe === 'function') {
        console.log("Usando window.gameDataManager.subscribe");
        window.gameDataManager.subscribe(updateUI);
      } 
      else {
        console.log("Intentando acceder a través de mainWindow");
        overwolf.windows.getMainWindow(function(mainWindow) {
          if (mainWindow && mainWindow.gameDataManager) {
            console.log("Usando mainWindow.gameDataManager.subscribe");
            mainWindow.gameDataManager.subscribe(updateUI);
          } else {
            console.error("No se pudo acceder al gameDataManager desde tab-stats");
          }
        });
      }
      
      // FORZAR ACTUALIZACIÓN DIRECTAMENTE - EXACTAMENTE como en tab-overview.html
      console.log("Llamando a forceUpdateActiveTab para actualizar inmediatamente");
      if (window.forceUpdateActiveTab) {
        window.forceUpdateActiveTab();
      }
      
      // Datos iniciales de test - SIMPLIFICADOS para evitar interferencias
      console.log("Llamando a updateUI directamente con datos de prueba");
      updateUI({
        summoner: { name: "Invocador de prueba", position: "Test" },
        match: { gameMode: "PRACTICETOOL", gameTime: 120, kills: 2, deaths: 1, assists: 3, cs: 50 },
        vision: { wardsPlaced: 2 },
        combat: {
          damageDealt: 1000,
          damageDealtToChampions: 500,
          damageTaken: 300,
          healing: 100
        },
        // Añadir algunas variables para mostrar en la tabla
        testVariables: {
          variable1: "valor1",
          variable2: 123,
          variable3: true,
          variable4: {
            subvar1: "subvalor1",
            subvar2: 456
          }
        }
      });
      
    } catch (e) {
      console.error('Error al inicializar tab-stats:', e);
    }
  });
  
  // NO EXPONER updateUI GLOBALMENTE - EXACTAMENTE como en tab-overview.html
  // window.updateUI = updateUI;
  
  // REFERENCIA TEMPORAL PARA COMPATIBILIDAD - EXACTAMENTE como en tab-overview.html
  window._statsUpdateUI = updateUI;
</script> 