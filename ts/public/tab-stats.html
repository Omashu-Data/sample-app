<!-- Tab de Estadísticas -->
<div class="stats-container">
  <div class="stats-header glass-panel">
    <div class="stats-title">
      <h2>Estadísticas de <span id="stats-player-name">Invocador</span></h2>
      <div class="stats-subtitle">
        <span id="stats-match-type">Partida Normal</span> - <span id="stats-game-time">00:00</span>
      </div>
    </div>
  </div>
  
  <div class="stats-sections">
    <!-- Sección de KDA Detallado -->
    <div class="stats-section glass-panel">
      <div class="stats-section-header">
        <h3>Desempeño en Combate</h3>
      </div>
      <div class="stats-section-content">
        <div class="stats-kda-container">
          <div class="stats-kda-card">
            <div class="stats-kda-value" id="stats-kills">0</div>
            <div class="stats-kda-label">Eliminaciones</div>
          </div>
          <div class="stats-kda-card">
            <div class="stats-kda-value" id="stats-deaths">0</div>
            <div class="stats-kda-label">Muertes</div>
          </div>
          <div class="stats-kda-card">
            <div class="stats-kda-value" id="stats-assists">0</div>
            <div class="stats-kda-label">Asistencias</div>
          </div>
          <div class="stats-kda-card">
            <div class="stats-kda-value" id="stats-kda-ratio">0.0</div>
            <div class="stats-kda-label">Ratio KDA</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Sección de Recursos -->
    <div class="stats-section glass-panel">
      <div class="stats-section-header">
        <h3>Recursos y Economía</h3>
      </div>
      <div class="stats-section-content">
        <div class="stats-metrics-grid">
          <div class="stats-metric">
            <div class="stats-metric-icon">
              <img src="../../img/gold-icon.svg" alt="Oro" />
            </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Oro Total</div>
              <div class="stats-metric-value" id="stats-gold">0</div>
            </div>
          </div>
          
          <div class="stats-metric">
            <div class="stats-metric-icon">
              <img src="../../img/cs-icon.svg" alt="CS" />
            </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">CS Total</div>
              <div class="stats-metric-value" id="stats-cs">0</div>
            </div>
          </div>
          
          <div class="stats-metric">
            <div class="stats-metric-icon">
              <img src="../../img/cs-per-min-icon.svg" alt="CS por minuto" />
            </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">CS por Minuto</div>
              <div class="stats-metric-value" id="stats-cs-per-min">0.0</div>
            </div>
          </div>
          
          <div class="stats-metric">
            <div class="stats-metric-icon">
              <img src="../../img/ward-icon.svg" alt="Wards" />
            </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Wards Colocados</div>
              <div class="stats-metric-value" id="stats-wards-placed">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Sección de Daño -->
    <div class="stats-section glass-panel">
      <div class="stats-section-header">
        <h3>Análisis de Daño</h3>
      </div>
      <div class="stats-section-content">
        <div class="stats-metrics-grid">
          <div class="stats-metric">
            <div class="stats-metric-icon damage-icon">
              <img src="../../img/damage-icon.svg" alt="Daño" />
            </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Daño Total</div>
              <div class="stats-metric-value" id="stats-total-damage">0</div>
            </div>
          </div>
          
          <div class="stats-metric">
            <div class="stats-metric-icon damage-icon">
              <img src="../../img/champion-damage-icon.svg" alt="Daño a campeones" />
            </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Daño a Campeones</div>
              <div class="stats-metric-value" id="stats-champion-damage">0</div>
            </div>
          </div>
          
          <div class="stats-metric">
            <div class="stats-metric-icon heal-icon">
              <img src="../../img/healing-icon.svg" alt="Curación" />
            </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Curación Total</div>
              <div class="stats-metric-value" id="stats-total-healing">0</div>
            </div>
          </div>
          
          <div class="stats-metric">
            <div class="stats-metric-icon damage-icon">
              <img src="../../img/damage-taken-icon.svg" alt="Daño recibido" />
            </div>
            <div class="stats-metric-info">
              <div class="stats-metric-name">Daño Recibido</div>
              <div class="stats-metric-value" id="stats-damage-taken">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Función para formatear el tiempo de juego - misma que en tab-overview.html
  function formatGameTime(seconds) {
    if (!seconds && seconds !== 0) return "00:00";
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  // Función para formatear números grandes con separadores de mil
  function formatNumber(num) {
    return new Intl.NumberFormat('es-ES').format(num);
  }

  // Función para calcular el ratio KDA
  function calculateKDARatio(kills, deaths, assists) {
    if (deaths === 0) return ((kills + assists) > 0 ? "Perfect" : "0.0");
    return ((kills + assists) / deaths).toFixed(1);
  }

  // Función de actualización para esta tab específica
  function updateUI(gameData) {
    console.log("Tab-stats recibiendo actualización de datos:", gameData);
    
    // CÓDIGO DE DEPURACIÓN: Verificar estructura real de datos
    console.log("Estructura de datos recibida en tab-stats:", 
      JSON.stringify({
        summoner: gameData.summoner ? Object.keys(gameData.summoner) : "undefined",
        match: gameData.match ? Object.keys(gameData.match) : "undefined",
        combat: gameData.combat ? Object.keys(gameData.combat) : "undefined",
        ward: gameData.ward ? Object.keys(gameData.ward) : "undefined",
        vision: gameData.vision ? Object.keys(gameData.vision) : "undefined",
        objectives: gameData.objectives ? Object.keys(gameData.objectives) : "undefined"
      })
    );
    
    // Si match o combat son undefined, intentar ver por qué
    if (!gameData.match) {
      console.warn("La propiedad 'match' es undefined en tab-stats");
      console.log("Propiedades en gameData:", Object.keys(gameData));
    }
    
    if (!gameData.combat) {
      console.warn("La propiedad 'combat' es undefined en tab-stats");
      // Buscar alternativas potenciales
      if (gameData.match && gameData.match.combat) {
        console.log("Se encontró una propiedad alternativa: gameData.match.combat");
        gameData.combat = gameData.match.combat;
      } else if (gameData.damage) {
        console.log("Se encontró una propiedad alternativa: gameData.damage");
        gameData.combat = gameData.damage;
      }
    }
    
    // Información del jugador
    if (gameData.summoner && gameData.summoner.name) {
      document.getElementById('stats-player-name').textContent = gameData.summoner.name;
    }
    
    // Tipo de partida y tiempo
    if (gameData.match) {
      if (gameData.match.gameMode) {
        document.getElementById('stats-match-type').textContent = gameData.match.gameMode;
      }
      
      if (gameData.match.gameTime !== undefined) {
        document.getElementById('stats-game-time').textContent = formatGameTime(gameData.match.gameTime);
      }
      
      // KDA
      document.getElementById('stats-kills').textContent = gameData.match.kills || 0;
      document.getElementById('stats-deaths').textContent = gameData.match.deaths || 0;
      document.getElementById('stats-assists').textContent = gameData.match.assists || 0;
      
      // Ratio KDA
      const kills = parseInt(gameData.match.kills) || 0;
      const deaths = parseInt(gameData.match.deaths) || 0;
      const assists = parseInt(gameData.match.assists) || 0;
      document.getElementById('stats-kda-ratio').textContent = calculateKDARatio(kills, deaths, assists);
      
      // CS y CS por minuto
      if (gameData.match.cs !== undefined) {
        document.getElementById('stats-cs').textContent = gameData.match.cs;
        
        if (gameData.match.gameTime !== undefined && gameData.match.gameTime > 0) {
          const gameTimeInMinutes = Math.max(gameData.match.gameTime / 60, 1);
          const csPerMinute = (gameData.match.cs / gameTimeInMinutes).toFixed(1);
          document.getElementById('stats-cs-per-min').textContent = csPerMinute;
        }
      }
      
      // Oro - Verificar múltiples ubicaciones posibles
      if (gameData.match.gold !== undefined) {
        document.getElementById('stats-gold').textContent = formatNumber(gameData.match.gold);
      } else if (gameData.gold !== undefined) {
        console.log("Encontrado oro en gameData.gold en lugar de gameData.match.gold");
        document.getElementById('stats-gold').textContent = formatNumber(gameData.gold);
      }
    }
    
    // Wards desde múltiples fuentes posibles
    let wardsPlaced = 0;
    if (gameData.ward && gameData.ward.placed !== undefined) {
      wardsPlaced = parseInt(gameData.ward.placed) || 0;
    } else if (gameData.vision && gameData.vision.wardsPlaced !== undefined) {
      wardsPlaced = gameData.vision.wardsPlaced;
    } else if (gameData.objectives && gameData.objectives.wardPlaced !== undefined) {
      wardsPlaced = gameData.objectives.wardPlaced;
    }
    document.getElementById('stats-wards-placed').textContent = wardsPlaced;
    
    // Daño desde diferentes fuentes
    if (gameData.combat) {
      if (gameData.combat.damageDealt !== undefined) {
        document.getElementById('stats-total-damage').textContent = formatNumber(gameData.combat.damageDealt);
      }
      
      if (gameData.combat.totalDamageToChampions !== undefined) {
        document.getElementById('stats-champion-damage').textContent = formatNumber(gameData.combat.totalDamageToChampions);
      } else if (gameData.combat.damageDealtToChampions !== undefined) {
        document.getElementById('stats-champion-damage').textContent = formatNumber(gameData.combat.damageDealtToChampions);
      }
      
      if (gameData.combat.damageTaken !== undefined) {
        document.getElementById('stats-damage-taken').textContent = formatNumber(gameData.combat.damageTaken);
      }
      
      if (gameData.combat.healing !== undefined) {
        document.getElementById('stats-total-healing').textContent = formatNumber(gameData.combat.healing);
      } else if (gameData.combat.healingDone !== undefined) {
        document.getElementById('stats-total-healing').textContent = formatNumber(gameData.combat.healingDone);
      }
    }
  }

  // Inicialización para suscribirse al gameDataManager - similar a tab-overview.html
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Tab-stats cargado, intentando suscribirme a gameDataManager");
    
    try {
      // CAMBIO IMPORTANTE: Adjuntar la función updateUI al elemento de pestaña
      const tabElement = document.querySelector('.stats-container').closest('.tabs__pane') || 
                        document.getElementById('stats-tab');
      
      if (tabElement) {
        console.log("Adjuntando función updateUI al elemento de pestaña:", tabElement.id);
        // Guardar la función en el elemento
        tabElement.updateUIFunction = updateUI;
        
        // También registrar en el objeto tabUpdateFunctions como respaldo
        if (!window.tabUpdateFunctions) window.tabUpdateFunctions = {};
        window.tabUpdateFunctions['stats-tab'] = updateUI;
      } else {
        console.warn("No se pudo encontrar el elemento de pestaña para adjuntar updateUI");
      }
      
      // Métodos para suscribirse al gameDataManager - igual que en tab-overview.html
      if (typeof window.subscribeToGameData === 'function') {
        console.log("Usando window.subscribeToGameData");
        window.subscribeToGameData(updateUI);
      } 
      else if (window.gameDataManager && typeof window.gameDataManager.subscribe === 'function') {
        console.log("Usando window.gameDataManager.subscribe");
        window.gameDataManager.subscribe(updateUI);
      } 
      else {
        console.log("Intentando acceder a través de mainWindow");
        overwolf.windows.getMainWindow(function(mainWindow) {
          if (mainWindow && mainWindow.gameDataManager) {
            console.log("Usando mainWindow.gameDataManager.subscribe");
            mainWindow.gameDataManager.subscribe(updateUI);
          } else {
            console.error("No se pudo acceder al gameDataManager desde tab-stats");
          }
        });
      }
      
      // Datos de prueba - similares pero ampliados respecto a tab-overview.html
      updateUI({
        summoner: { name: "Invocador de prueba", position: "Test" },
        match: { 
          gameTime: 1200, 
          gameMode: "Ranked Solo/Duo",
          kills: 5, 
          deaths: 2, 
          assists: 8,
          cs: 180,
          gold: 8500
        },
        ward: { placed: 12 },
        combat: {
          damageDealt: 85000,
          damageDealtToChampions: 12500,
          damageTaken: 15000,
          healing: 3500
        }
      });
      
    } catch (e) {
      console.error('Error al inicializar tab-stats:', e);
    }
  });
  
  // CAMBIO IMPORTANTE: Ya no exponemos updateUI globalmente
  // window.updateUI = updateUI;
  
  // Pero mantenemos una referencia para compatibilidad temporal
  window._statsUpdateUI = updateUI;
</script> 