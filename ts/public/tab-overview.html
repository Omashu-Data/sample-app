<!-- Tab de Resumen - Página principal de la aplicación -->
<div class="overview-container">
  <div class="overview-header">
    <div class="overview-player">
      <div class="overview-player-profile">
        <div class="overview-player-image"></div>
        <div class="overview-player-info">
          <h2 id="player-name">NombreJugador</h2>
          <div class="overview-player-role">
            <img src="../../img/role-icon.svg" alt="Rol" />
            <span id="player-role">Rol Principal</span>
          </div>
        </div>
      </div>
      <div class="overview-match-info">
        <div class="overview-timer">
          <span class="overview-label">Tiempo:</span>
          <span id="game-time-value">00:00</span>
        </div>
        <div class="overview-kda">
          <span id="kda-kills" class="kda-value">0</span>
          <span class="kda-separator">/</span>
          <span id="kda-deaths" class="kda-value">0</span>
          <span class="kda-separator">/</span>
          <span id="kda-assists" class="kda-value">0</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="overview-sections">
    <div class="overview-section">
      <div class="overview-section-header">
        <h3>
          <span class="icon-container">
            <img src="../../img/strength-icon.svg" alt="Fortalezas" />
          </span>
          Fortalezas
        </h3>
      </div>
      <div class="overview-section-content">
        <div class="overview-stat">
          <div class="overview-stat-header">
            <div class="overview-stat-icon"><img src="../../img/accuracy-icon.svg" alt="Precisión" /></div>
            <div class="overview-stat-name">Precisión</div>
          </div>
          <div class="overview-stat-value">80%</div>
          <div class="overview-stat-desc">Mayor precisión en disparos, 30% por encima del promedio.</div>
        </div>
        
        <div class="overview-stat">
          <div class="overview-stat-header">
            <div class="overview-stat-icon"><img src="../../img/reflexes-icon.svg" alt="Reflejos" /></div>
            <div class="overview-stat-name">Reflejos</div>
          </div>
          <div class="overview-stat-value">15%</div>
          <div class="overview-stat-desc">Tiempo de reacción 15% más rápido que el promedio en tu nivel.</div>
        </div>
        
        <div class="overview-stat">
          <div class="overview-stat-header">
            <div class="overview-stat-icon"><img src="../../img/rotations-icon.svg" alt="Rotaciones" /></div>
            <div class="overview-stat-name">Rotaciones</div>
          </div>
          <div class="overview-stat-value">8</div>
          <div class="overview-stat-desc">8 rotaciones efectivas, contribuyendo a 3 objetivos de equipo.</div>
        </div>
      </div>
    </div>
    
    <div class="overview-section">
      <div class="overview-section-header">
        <h3>
          <span class="icon-container warning">
            <img src="../../img/weakness-icon.svg" alt="Debilidades" />
          </span>
          Debilidades
        </h3>
      </div>
      <div class="overview-section-content">
        <div class="overview-stat">
          <div class="overview-stat-header">
            <div class="overview-stat-icon"><img src="../../img/vision-icon.svg" alt="Visión" /></div>
            <div class="overview-stat-name">Visión</div>
          </div>
          <div class="overview-stat-value">25%</div>
          <div class="overview-stat-desc">Menos control de visión que el promedio de tu nivel.</div>
        </div>
        
        <div class="overview-stat">
          <div class="overview-stat-header">
            <div class="overview-stat-icon"><img src="../../img/positioning-icon.svg" alt="Posicionamiento" /></div>
            <div class="overview-stat-name">Posicionamiento</div>
          </div>
          <div class="overview-stat-value">67.5%</div>
          <div class="overview-stat-desc">67.5% de muertes por flanqueo, 22% más que el promedio.</div>
        </div>
        
        <div class="overview-stat">
          <div class="overview-stat-header">
            <div class="overview-stat-icon"><img src="../../img/resources-icon.svg" alt="Uso de recursos" /></div>
            <div class="overview-stat-name">Uso de recursos</div>
          </div>
          <div class="overview-stat-value">18%</div>
          <div class="overview-stat-desc">Economía 18% menos eficiente que jugadores de tu nivel.</div>
        </div>
      </div>
    </div>
    
    <div class="overview-section">
      <div class="overview-section-header">
        <h3>
          <span class="icon-container">
            <img src="../../img/challenges-icon.svg" alt="Retos" />
          </span>
          Retos para esta partida
        </h3>
      </div>
      <div class="overview-section-content challenges">
        <div class="overview-challenge">
          <div class="overview-challenge-icon">
            <img src="../../img/ward-icon.svg" alt="Colocar wards" />
          </div>
          <div class="overview-challenge-info">
            <div class="overview-challenge-name">Coloca 5 wards</div>
            <div class="overview-challenge-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width: 2%;"></div>
              </div>
              <div class="progress-text">2%</div>
            </div>
          </div>
        </div>
        
        <div class="overview-challenge">
          <div class="overview-challenge-icon">
            <img src="../../img/survive-icon.svg" alt="Sobrevivir" />
          </div>
          <div class="overview-challenge-info">
            <div class="overview-challenge-name">Sobrevive 3 emboscadas</div>
            <div class="overview-challenge-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width: 33%;"></div>
              </div>
              <div class="progress-text">1/3</div>
            </div>
          </div>
        </div>
        
        <div class="overview-challenge">
          <div class="overview-challenge-icon">
            <img src="../../img/economy-icon.svg" alt="Economía" />
          </div>
          <div class="overview-challenge-info">
            <div class="overview-challenge-name">Optimiza compras de objetos</div>
            <div class="overview-challenge-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width: 23%;"></div>
              </div>
              <div class="progress-text">23%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="overview-performance">
    <h3>Rendimiento General</h3>
    <div class="overview-rating">B+</div>
  </div>
</div>

<script>
  // Función para formatear el tiempo de juego
  function formatGameTime(seconds) {
    if (!seconds && seconds !== 0) return "00:00";
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  // Función para actualizar los elementos de la UI con los datos del juego
  function updateUI(gameData) {
    console.log('tab-overview: updateUI llamada con datos:', 
      JSON.stringify({
        summoner: gameData.summoner ? gameData.summoner.name : 'no disponible',
        gameTime: gameData.match ? gameData.match.gameTime : 'no disponible',
        kda: gameData.match ? `${gameData.match.kills}/${gameData.match.deaths}/${gameData.match.assists}` : 'no disponible'
      })
    );

    try {
      // Crear un marcador de tiempo para depuración
      const ahora = new Date();
      const tiempoUI = document.createElement('div');
      tiempoUI.style.position = 'absolute';
      tiempoUI.style.top = '5px';
      tiempoUI.style.right = '5px';
      tiempoUI.style.background = 'rgba(0,0,0,0.5)';
      tiempoUI.style.color = 'white';
      tiempoUI.style.padding = '3px 6px';
      tiempoUI.style.borderRadius = '3px';
      tiempoUI.style.fontSize = '10px';
      tiempoUI.style.zIndex = '9999';
      tiempoUI.textContent = `Última actualización: ${ahora.toLocaleTimeString()}.${ahora.getMilliseconds()}`;
      document.querySelector('.overview-container').appendChild(tiempoUI);
      
      // Eliminar marcadores antiguos (mantener solo el último)
      const marcadores = document.querySelectorAll('.overview-container > div[style*="position: absolute"]');
      if (marcadores.length > 1) {
        for (let i = 0; i < marcadores.length - 1; i++) {
          marcadores[i].remove();
        }
      }
      
      // Actualizar nombre del jugador
      if (gameData.summoner && gameData.summoner.name) {
        const playerNameElement = document.getElementById('player-name');
        if (playerNameElement) {
          playerNameElement.textContent = gameData.summoner.name || "Desconocido";
          // Actualizar también el icono de jugador con la primera letra
          const playerImageElement = document.querySelector('.overview-player-image');
          if (playerImageElement) {
            playerImageElement.textContent = (gameData.summoner.name.charAt(0) || "?").toUpperCase();
          }
          console.log('Nombre de jugador actualizado:', gameData.summoner.name);
        } else {
          console.error('Elemento player-name no encontrado');
        }
        
        // Actualizar rol del jugador si está disponible
        if (gameData.summoner.position || gameData.summoner.role) {
          const playerRoleElement = document.getElementById('player-role');
          if (playerRoleElement) {
            playerRoleElement.textContent = gameData.summoner.position || gameData.summoner.role || "Rol Principal";
          }
        }
      }

      // Actualizar tiempo de juego - MEJORADO para asegurar actualización
      if (gameData.match && gameData.match.gameTime !== undefined) {
        const gameTimeElement = document.getElementById('game-time-value');
        if (gameTimeElement) {
          const formattedTime = formatGameTime(gameData.match.gameTime);
          if (gameTimeElement.textContent !== formattedTime) {
            gameTimeElement.textContent = formattedTime;
            gameTimeElement.setAttribute('data-last-update', Date.now().toString());
            console.log('Tiempo de juego actualizado:', formattedTime);
          }
        } else {
          console.error('Elemento game-time-value no encontrado');
        }
      }

      // Actualizar KDA con atributos para comparar versiones
      if (gameData.match) {
        // Actualizar Kills
        const killsElement = document.getElementById('kda-kills');
        if (killsElement) {
          const killsValue = gameData.match.kills || 0;
          const oldValue = parseInt(killsElement.getAttribute('data-value') || '0');
          
          if (oldValue !== killsValue) {
            killsElement.textContent = killsValue.toString();
            killsElement.setAttribute('data-value', killsValue.toString());
            killsElement.style.animation = 'none';
            killsElement.offsetHeight; // Forzar reflow
            killsElement.style.animation = 'highlight 0.5s';
            console.log('Kills actualizadas:', killsValue, '(anterior:', oldValue, ')');
          }
        } else {
          console.error('Elemento kda-kills no encontrado');
        }
        
        // Actualizar Deaths
        const deathsElement = document.getElementById('kda-deaths');
        if (deathsElement) {
          const deathsValue = gameData.match.deaths || 0;
          const oldValue = parseInt(deathsElement.getAttribute('data-value') || '0');
          
          if (oldValue !== deathsValue) {
            deathsElement.textContent = deathsValue.toString();
            deathsElement.setAttribute('data-value', deathsValue.toString());
            deathsElement.style.animation = 'none';
            deathsElement.offsetHeight; // Forzar reflow
            deathsElement.style.animation = 'highlight 0.5s';
            console.log('Deaths actualizadas:', deathsValue, '(anterior:', oldValue, ')');
          }
        } else {
          console.error('Elemento kda-deaths no encontrado');
        }
        
        // Actualizar Assists
        const assistsElement = document.getElementById('kda-assists');
        if (assistsElement) {
          const assistsValue = gameData.match.assists || 0;
          const oldValue = parseInt(assistsElement.getAttribute('data-value') || '0');
          
          if (oldValue !== assistsValue) {
            assistsElement.textContent = assistsValue.toString();
            assistsElement.setAttribute('data-value', assistsValue.toString());
            assistsElement.style.animation = 'none';
            assistsElement.offsetHeight; // Forzar reflow
            assistsElement.style.animation = 'highlight 0.5s';
            console.log('Assists actualizadas:', assistsValue, '(anterior:', oldValue, ')');
          }
        } else {
          console.error('Elemento kda-assists no encontrado');
        }
        
        // Actualizar los retos basados en KDA y otras métricas
        updateChallenges(gameData);
      }

      // Añadimos datos de depuración visibles para comprobar la recepción
      document.querySelector('.overview-rating').innerHTML = `
        <div style="text-align: center; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 5px; margin-bottom: 5px; font-size: 12px;">
          <strong>Datos recibidos:</strong><br>
          Jugador: ${gameData.summoner?.name || "N/A"}<br>
          Tiempo: ${formatGameTime(gameData.match?.gameTime)}<br>
          KDA: ${gameData.match?.kills || 0}/${gameData.match?.deaths || 0}/${gameData.match?.assists || 0}<br>
          <small>Última actualización: ${new Date().toLocaleTimeString()}</small>
        </div>
        B+`;
    } catch (e) {
      console.error('Error al actualizar la UI:', e);
      document.querySelector('.overview-rating').innerHTML = `
        <div style="text-align: center; padding: 5px; background: rgba(255,0,0,0.2); border-radius: 5px; margin-bottom: 5px; font-size: 12px;">
          <strong>Error al actualizar UI:</strong><br>
          ${e.message}<br>
          <small>Última actualización: ${new Date().toLocaleTimeString()}</small>
        </div>
        B+`;
    }
  }
  
  // Función para actualizar los retos basados en los datos del juego
  function updateChallenges(gameData) {
    // Reto: Colocar wards
    if (gameData.objectives && gameData.objectives.wardPlaced !== undefined) {
      const wardProgress = Math.min(gameData.objectives.wardPlaced / 5 * 100, 100);
      const wardProgressBar = document.querySelector('.overview-challenge:nth-child(1) .progress-fill');
      const wardProgressText = document.querySelector('.overview-challenge:nth-child(1) .progress-text');
      
      if (wardProgressBar) {
        wardProgressBar.style.width = `${wardProgress}%`;
      }
      if (wardProgressText) {
        wardProgressText.textContent = `${Math.round(wardProgress)}%`;
      }
    }
    
    // Reto: Supervivencia (basado en ratio K/D bueno)
    if (gameData.match.kills !== undefined && gameData.match.deaths !== undefined) {
      const kdRatio = gameData.match.deaths > 0 ? gameData.match.kills / gameData.match.deaths : gameData.match.kills;
      const survivalScore = Math.min(kdRatio, 3); // Máx 3
      const survivalProgress = (survivalScore / 3) * 100;
      
      const survivalProgressBar = document.querySelector('.overview-challenge:nth-child(2) .progress-fill');
      const survivalProgressText = document.querySelector('.overview-challenge:nth-child(2) .progress-text');
      
      if (survivalProgressBar) {
        survivalProgressBar.style.width = `${survivalProgress}%`;
      }
      if (survivalProgressText) {
        survivalProgressText.textContent = `${Math.round(survivalScore)}/3`;
      }
    }
    
    // Reto: Economía (basado en oro y cs)
    if (gameData.match.gold !== undefined && gameData.match.cs !== undefined) {
      // Simple cálculo de eficiencia: oro por minion
      const goldPerCS = gameData.match.cs > 0 ? gameData.match.gold / gameData.match.cs : 0;
      // Normalizar a un porcentaje (considerando 25 oro por minion como 100%)
      const economyRatio = Math.min((goldPerCS / 25) * 100, 100);
      
      const economyProgressBar = document.querySelector('.overview-challenge:nth-child(3) .progress-fill');
      const economyProgressText = document.querySelector('.overview-challenge:nth-child(3) .progress-text');
      
      if (economyProgressBar) {
        economyProgressBar.style.width = `${economyRatio}%`;
      }
      if (economyProgressText) {
        economyProgressText.textContent = `${Math.round(economyRatio)}%`;
      }
    }
  }

  // Añadir estilos para la animación de destacado
  const highlightStyle = document.createElement('style');
  highlightStyle.textContent = `
    @keyframes highlight {
      0% { color: white; background-color: rgba(0, 255, 0, 0.5); }
      100% { color: inherit; background-color: transparent; }
    }
  `;
  document.head.appendChild(highlightStyle);

  // Verificar y suscribirse a los datos del juego con métodos mejorados
  function initGameDataSubscription() {
    console.log('tab-overview: Intentando inicializar suscripción a datos del juego');
    
    // ---- NUEVO MÉTODO: Leer datos desde archivo ----
    function readGameDataFromFile() {
      // Leer datos de archivo temporal (varios intentos para asegurar compatibilidad)
      const possiblePaths = [
        overwolf.io.paths.localAppData + '\\Overwolf\\eMePe-AppData\\lol-game-data.json',
        overwolf.io.paths.localAppData + '\\Overwolf\\eMePe-AppData\\lol-game-data-backup.json',
        overwolf.io.paths.documents + '\\Overwolf\\lol-game-data.json'
      ];
      
      // Función para intentar leer cada archivo en secuencia
      function tryReadFile(index) {
        if (index >= possiblePaths.length) {
          console.log('No se encontraron archivos de datos de juego');
          return;
        }
        
        const path = possiblePaths[index];
        overwolf.io.fileExists(path, (existsResult) => {
          if (existsResult.success && existsResult.exists) {
            overwolf.io.readFileContents(path, 'UTF8', (readResult) => {
              if (readResult.success) {
                try {
                  const gameData = JSON.parse(readResult.content);
                  console.log('Datos leídos exitosamente del archivo:', path);
                  console.log('Datos de juego:', {
                    nombre: gameData.summoner.name,
                    champion: gameData.summoner.champion,
                    kda: `${gameData.match.kills}/${gameData.match.deaths}/${gameData.match.assists}`,
                    tiempo: gameData.match.gameTime
                  });
                  updateUI(gameData);
                  
                  // Mostrar fuente de datos para depuración
                  const statusElement = document.querySelector('.overview-rating');
                  if (statusElement) {
                    const basePath = path.split('\\').pop();
                    statusElement.innerHTML = 
                      `<small>Datos recibidos de: ${basePath}</small><br>
                       <small>Última actualización: ${new Date().toLocaleTimeString()}</small><br>B+`;
                  }
                } catch (e) {
                  console.error('Error al parsear datos del archivo:', e);
                  // Intenta el siguiente archivo
                  tryReadFile(index + 1);
                }
              } else {
                console.error('Error al leer el archivo:', readResult.error);
                // Intenta el siguiente archivo
                tryReadFile(index + 1);
              }
            });
          } else {
            console.log(`Archivo no encontrado: ${path}`);
            // Intenta el siguiente archivo
            tryReadFile(index + 1);
          }
        });
      }
      
      // Iniciar intentos de lectura
      tryReadFile(0);
      
      // Comprobar periódicamente el archivo
      setTimeout(readGameDataFromFile, 1000);
    }
    
    // Iniciar lectura de archivo
    readGameDataFromFile();
    
    // Mantener métodos anteriores también
    function checkLocalStorage() {
      try {
        const storedData = localStorage.getItem('lol_game_data');
        if (storedData) {
          console.log('Datos encontrados en localStorage');
          const gameData = JSON.parse(storedData);
          updateUI(gameData);
        }
      } catch (e) {
        console.error('Error al leer de localStorage:', e);
      }
    }
    
    // Verificar localStorage cada 2 segundos
    setInterval(checkLocalStorage, 2000);
    
    // Escuchar mensajes directos
    function setupDirectMessageListener() {
      overwolf.windows.onMessageReceived.removeListener(handleDirectMessage);
      overwolf.windows.onMessageReceived.addListener(handleDirectMessage);
      console.log('Listener de mensajes directos configurado');
    }
    
    function handleDirectMessage(message) {
      console.log('Mensaje directo recibido:', message);
      if (message && message.id === 'game_data_update' && message.content) {
        console.log('Actualizando UI desde mensaje directo');
        updateUI(message.content);
      }
    }
    
    // Configurar el listener para mensajes directos
    setupDirectMessageListener();
    
    // Verificar datos en la ventana principal periódicamente
    function checkMainWindowData() {
      overwolf.windows.getMainWindow(function(mainWindow) {
        if (mainWindow && mainWindow._latestGameData) {
          console.log('Datos encontrados en mainWindow._latestGameData');
          updateUI(mainWindow._latestGameData);
        }
      });
    }
    
    // Comprobar datos de la ventana principal cada 2 segundos
    setInterval(checkMainWindowData, 2000);
    
    // Mostrar que estamos escuchando para depuración
    document.querySelector('.overview-rating').innerHTML = 
      `<small>Buscando archivos de datos...</small><br>
       <small>Última verificación: ${new Date().toLocaleTimeString()}</small><br>B+`;
  }

  // Inicializa la suscripción a los datos del juego
  document.addEventListener('DOMContentLoaded', function() {
    console.log('tab-overview: DOM cargado, intentando conectar con gameDataManager...');
    
    // MÉTODO DIRECTO: Intentar obtener el gameDataManager de la ventana padre
    try {
      // Método 1: Suscribirse directamente usando window.subscribeToGameData (método expuesto)
      if (typeof window.subscribeToGameData === 'function') {
        console.log('tab-overview: Usando window.subscribeToGameData...');
        window.subscribeToGameData(updateUI);
        
        // Mostrar mensaje de conexión exitosa
        document.querySelector('.overview-rating').innerHTML = `
          <div style="text-align: center; padding: 5px; background: rgba(0,128,0,0.2); border-radius: 5px; margin-bottom: 5px; font-size: 12px;">
            <strong>Conectado correctamente</strong><br>
            Esperando datos del juego...<br>
            <small>Conexión establecida: ${new Date().toLocaleTimeString()}</small>
          </div>
          B+`;
        
        console.log('tab-overview: Conexión exitosa con gameDataManager');
      } 
      // Método 2: Usar el objeto global gameDataManager directamente
      else if (window.gameDataManager && typeof window.gameDataManager.subscribe === 'function') {
        console.log('tab-overview: Usando window.gameDataManager.subscribe...');
        window.gameDataManager.subscribe(updateUI);
        
        // Mostrar mensaje de conexión exitosa
        document.querySelector('.overview-rating').innerHTML = `
          <div style="text-align: center; padding: 5px; background: rgba(0,128,0,0.2); border-radius: 5px; margin-bottom: 5px; font-size: 12px;">
            <strong>Conectado directamente a gameDataManager</strong><br>
            Esperando datos del juego...<br>
            <small>Conexión establecida: ${new Date().toLocaleTimeString()}</small>
          </div>
          B+`;
        
        console.log('tab-overview: Conexión exitosa con gameDataManager.subscribe');
      } 
      // Método 3: Acceder a través de la ventana principal
      else {
        console.log('tab-overview: Accediendo a gameDataManager a través de overwolf.windows.getMainWindow...');
        overwolf.windows.getMainWindow(function(mainWindow) {
          if (mainWindow && mainWindow.gameDataManager && typeof mainWindow.gameDataManager.subscribe === 'function') {
            console.log('tab-overview: Acceso exitoso a gameDataManager a través de getMainWindow');
            mainWindow.gameDataManager.subscribe(updateUI);
            
            // Mostrar mensaje de conexión exitosa
            document.querySelector('.overview-rating').innerHTML = `
              <div style="text-align: center; padding: 5px; background: rgba(0,128,0,0.2); border-radius: 5px; margin-bottom: 5px; font-size: 12px;">
                <strong>Conectado vía ventana principal</strong><br>
                Esperando datos del juego...<br>
                <small>Conexión establecida: ${new Date().toLocaleTimeString()}</small>
              </div>
              B+`;
          } else {
            console.error('tab-overview: No se pudo acceder a gameDataManager desde la ventana principal');
            // Si falla, iniciar los métodos anteriores
            initGameDataSubscription();
          }
        });
      }
    } catch (e) {
      console.error('tab-overview: Error al conectar con gameDataManager:', e);
      document.querySelector('.overview-rating').innerHTML = `
        <div style="text-align: center; padding: 5px; background: rgba(255,0,0,0.2); border-radius: 5px; margin-bottom: 5px; font-size: 12px;">
          <strong>Error de conexión</strong><br>
          ${e.message}<br>
          <small>Intentando métodos alternativos...</small>
        </div>
        B+`;
      
      // Si falla, iniciar los métodos anteriores
      initGameDataSubscription();
    }
  });
</script> 